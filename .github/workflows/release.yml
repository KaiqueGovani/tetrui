name: Build and Release

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  build:
    environment: actions
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            goos: linux
            goarch: amd64
          - runner: ubuntu-latest
            goos: linux
            goarch: arm64
          - runner: macos-latest
            goos: darwin
            goarch: amd64
          - runner: macos-latest
            goos: darwin
            goarch: arm64
          - runner: windows-latest
            goos: windows
            goarch: amd64
    runs-on: ${{ matrix.runner }}
    env:
      TETRUI_SCORE_API_URL: ${{ secrets.TETRUI_SCORE_API_URL }}
      TETRUI_SCORE_API_KEY: ${{ secrets.TETRUI_SCORE_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Install audio deps (Linux)
        if: matrix.goos == 'linux'
        run: |
          sudo apt-get update
          if [ "${{ matrix.goarch }}" = "arm64" ]; then
            # Set up cross-compilation for ARM64
            sudo dpkg --add-architecture arm64
            tmpfile=$(mktemp)
            trap 'rm -f "$tmpfile"' EXIT
            sudo awk '
              /^$/ {
                if (in_block && !has_arch) {
                  print "Architectures: amd64"
                }
                in_block = 0
                has_arch = 0
                print
                next
              }
              /^URIs:/ { in_block = 1 }
              /^Architectures:/ { has_arch = 1 }
              { print }
              END {
                if (in_block && !has_arch) {
                  print "Architectures: amd64"
                }
              }
            ' /etc/apt/sources.list.d/ubuntu.sources | sudo tee "$tmpfile" > /dev/null
            sudo install -m 644 "$tmpfile" /etc/apt/sources.list.d/ubuntu.sources
            trap - EXIT
            rm -f "$tmpfile"
            cat <<EOF | sudo tee /etc/apt/sources.list.d/ubuntu-arm64.sources
Types: deb
URIs: http://ports.ubuntu.com/ubuntu-ports
Suites: $(lsb_release -sc) $(lsb_release -sc)-updates
Components: main restricted universe multiverse
Architectures: arm64
Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg
EOF
            sudo apt-get update
            sudo apt-get install -y gcc-aarch64-linux-gnu pkg-config
            sudo apt-get install -y libasound2-dev:arm64
          else
            sudo apt-get install -y pkg-config libasound2-dev
          fi

      - name: Set up cross-compilation environment (Linux ARM64)
        if: matrix.goos == 'linux' && matrix.goarch == 'arm64'
        run: |
          echo "CC=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig" >> $GITHUB_ENV
          echo "CGO_ENABLED=1" >> $GITHUB_ENV

      - name: Build
        shell: bash
        run: |
          mkdir -p dist
          GOOS=${{ matrix.goos }}
          GOARCH=${{ matrix.goarch }}
          echo "GOOS=$GOOS" >> $GITHUB_ENV
          echo "GOARCH=$GOARCH" >> $GITHUB_ENV
          EXT=""
          if [ "$GOOS" = "windows" ]; then
            EXT=".exe"
          fi
          go build -trimpath -ldflags "-X main.defaultScoreAPIURL=${TETRUI_SCORE_API_URL} -X main.defaultScoreAPIKey=${TETRUI_SCORE_API_KEY}" -o "dist/tetrui-${GOOS}-${GOARCH}${EXT}" ./cmd/tetrui

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tetrui-${{ env.GOOS }}-${{ env.GOARCH }}
          path: dist/*

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Publish nightly release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          name: Nightly
          prerelease: true
          files: dist/**
